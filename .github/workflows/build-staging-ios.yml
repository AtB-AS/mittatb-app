name: Build staging iOS project
on:
  workflow_dispatch:
    inputs:
      force-build:
        description: 'Forces a new build and ignores the cache'
        required: false
        type: choice
        default: 'false'
        options:
          - 'true'
          - 'false'
      org:
        description: 'Which orgs to build (comma-separated, blank=all)'
        required: false
        type: string
        default: 'atb,nfk,fram,troms'
  push:
    branches:
      - master
      - release/**
  schedule:
    - cron: '0 1 * * 1-5'

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.force.outputs.should_build || steps.detect.outputs.should_build }}
    steps:
      - name: Force build
        id: force
        if: inputs.force-build == 'true' || github.event_name == 'schedule'
        run: echo "should_build=true" >> $GITHUB_OUTPUT
      - uses: actions/checkout@v4
        if: steps.force.outputs.should_build != 'true'
        with:
          fetch-depth: 2
      - name: Detect change after checkout
        id: detect
        if: steps.force.outputs.should_build != 'true'
        uses: ./.github/actions/detect-changes

  setup:
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build != 'false'
    name: Set-up tools and warm up cache
    runs-on: macOS-26
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          ORG_INPUT="${{ inputs.org }}"
          ORG_INPUT="${ORG_INPUT:-atb,nfk,fram,troms}"
          MATRIX=$(echo "$ORG_INPUT" | tr -d ' ' | jq -Rc 'split(",")')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
      - name: Checkout project
        uses: actions/checkout@v4
      - name: Cache pods
        uses: actions/cache@v4
        id: pods-cache
        with:
          lookup-only: true
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: pods-${{ hashFiles('yarn.lock') }}-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            pods-${{ hashFiles('yarn.lock') }}-
            pods-
      - name: Cache node_modules
        uses: actions/cache@v4
        id: modules-cache
        with:
          lookup-only: true
          path: '**/node_modules'
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/patches/**.patch') }}
          restore-keys: |
            node-modules-${{ runner.os }}-
      # ===== Install node-modules  =====
      - name: Install node v22
        uses: actions/setup-node@v5
        if: inputs.force-build == 'true' || steps.modules-cache.outputs.cache-hit != 'true'
        with:
          node-version: 22
          cache: 'yarn'

      - name: Add Entur private registry credentials
        shell: bash
        if: steps.modules-cache.outputs.cache-hit != 'true'
        run: bash ./scripts/add-entur-private-registry.sh
        env:
          ENTUR_REGISTRY_USER: ${{ vars.ENTUR_REGISTRY_USER }}
          ENTUR_REGISTRY_TOKEN: ${{ secrets.ENTUR_REGISTRY_TOKEN }}
      - name: Install node_modules
        if: inputs.force-build == 'true' || steps.modules-cache.outputs.cache-hit != 'true'
        run: yarn install --frozen-lockfile
      # ===== Ruby & Bundler =====
      - name: Setup ruby and bundle install
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.0
          cache-version: 2
          bundler-cache: true
      - name: Setup Xcode version
        if: inputs.force-build == 'true' || steps.pods-cache.outputs.cache-hit != 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
      - name: Install CocoaPods
        working-directory: ios
        if: inputs.force-build == 'true' || steps.pods-cache.outputs.cache-hit != 'true'
        run: bundle exec pod install

  build-ios:
    needs: setup
    name: Build iOS (${{ matrix.org }})
    strategy:
      fail-fast: false
      matrix:
        org: ${{ fromJson(needs.setup.outputs.matrix) }}
    environment: ${{ matrix.org }}
    timeout-minutes: 360
    runs-on: macOS-26
    env:
      KEYCHAIN_NAME: 'CI'
    steps:
      - name: Checkout project
        uses: actions/checkout@v4
      - name: Get potential cached ipa & dsym
        uses: actions/cache@v4
        id: ipa-cache
        if: inputs.force-build != 'true'
        with:
          path: |
            AtB.ipa
            AtB.app.dSYM.zip
          key: ${{ matrix.org }}-ipa-app-ios-cache-${{ hashFiles('ios/**') }}-${{ hashFiles('.yalc/**') }}-${{ hashFiles('.env') }}-${{ hashFiles('assets*/') }}
      - name: Setup build dependencies, environment and assets
        uses: ./.github/actions/ios-build-setup
        with:
          app-environment: 'staging'
          app-org: ${{ matrix.org }}
          git-crypt-key: ${{ secrets.GIT_CRYPT_KEY }}
          entur-registry-user: ${{ vars.ENTUR_REGISTRY_USER }}
          entur-registry-token: ${{ secrets.ENTUR_REGISTRY_TOKEN }}
          match-ssh-private-key: ${{ secrets.MATCH_SSH_PRIVATE_KEY }}
          force-build: ${{ inputs.force-build }}
          skip-heavy-steps: ${{ inputs.force-build != 'true' && steps.ipa-cache.outputs.cache-hit == 'true' }}
      - name: Get potential cached pods
        uses: actions/cache@v4
        id: pods-cache
        if: steps.ipa-cache.outputs.cache-hit != 'true'
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: pods-${{ hashFiles('yarn.lock') }}-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            pods-${{ hashFiles('yarn.lock') }}-
            pods-
      - name: Disable widget
        if: ${{ env.ENABLE_WIDGET != 'true' && steps.ipa-cache.outputs.cache-hit != 'true' }}
        run: bundle exec configure_extensions remove ios/atb.xcodeproj app departureWidget AtbAppIntent
      - name: Run fastlane cert match
        if: steps.ipa-cache.outputs.cache-hit == 'true'
        run: bundle exec fastlane ios get_certs
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_NAME: ${{ env.KEYCHAIN_NAME }}
      - name: Run fastlane build
        if: inputs.force-build == 'true' || steps.ipa-cache.outputs.cache-hit != 'true'
        run: bundle exec fastlane ios build
        env:
          # A workaround for Github Actions which breaks for a timeout in some cases,
          # so this sets a higher value for TIMEOUT and reduces the number of retries
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 180
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 1
          EXPORT_METHOD: 'ad-hoc'
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_NAME: ${{ env.KEYCHAIN_NAME }}
          SKIP_PODS: ${{ steps.pods-cache.outputs.cache-hit == 'true'}}
          PATH: /usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:/usr/sbin:/sbin
      - name: Replace ipa bundle
        if: steps.ipa-cache.outputs.cache-hit == 'true'
        run: sh ./scripts/ios/replace-bundle.sh
        env:
          IPA_FILE_NAME: 'AtB.ipa'
          APP_NAME: 'AtB.app'
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_NAME: ${{ env.KEYCHAIN_NAME }}
      - name: Generate release notes
        id: release-notes
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          OUTPUT_FILE: ./release-notes.txt
        run: bash ./scripts/generate-staging-release-notes.sh
      - name: Distribute to Firebase App Distribution
        run: |
          echo "${{ secrets.FIREBASE_DISTRIBUTION_CREDENTIALS}}" | base64 --decode > google-services.json
          bundle exec fastlane ios firebase_distribution_staging
        env:
          GCP_CREDENTIALS_PATH: google-services.json
          FIREBASE_APP_ID_IOS: ${{ secrets.FIREBASE_APP_ID_IOS }}
          RELEASE_NOTES_FILE: ./release-notes.txt
      - name: Setup Bugsnag CLI
        uses: ./.github/actions/setup-bugsnag-cli
      - name: Upload Bugsnag symbols
        uses: ./.github/actions/ios-upload-bugsnag
        with:
          bugsnag-api-key: ${{ secrets.BUGSNAG_API_KEY }}
          skip-create-sourcemaps: ${{ inputs.force-build != 'true' && steps.ipa-cache.outputs.cache-hit == 'true' }}
          skip-dsyms: ${{ inputs.force-build != 'true' && steps.ipa-cache.outputs.cache-hit == 'true' }}
      - name: Register app version
        run: sh ./scripts/ios/register-app-version.sh
        env:
          ENTUR_PUBLISH_CLIENT: ${{ secrets.ABT_ENTUR_PUBLISH_CLIENT_STAGING}}
