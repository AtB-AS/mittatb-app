name: Renew certificates
on:
  workflow_dispatch:
    inputs:
      org:
        description: 'Org'
        required: true
        type: choice
        options:
          - atb
          - nfk
      environment: 
        description: 'App environment'
        required: true
        type: choice
        options:
          - staging
          - store
          - development
jobs:
  renew-certificates:
    name: Renew certificates
    environment: ${{ inputs.org }}
    timeout-minutes: 180
    runs-on: macOS-12
    steps:
      - name: Checkout project
        uses: actions/checkout@v1
      - name: Setup ruby and bundle install
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7.6
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
      - name: Decrypt env files
        shell: bash
        run: sh ./scripts/git-crypt-unlock.sh
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      - name: Set environment
        shell: bash
        run: |
          echo "Copying $ENV_FOLDER/.env file to root"
          cp $ENV_FOLDER/.env .

          echo "Copying $ENV_FOLDER/.env file to fastlane/.env.default"
          cp $ENV_FOLDER/.env fastlane/.env.default
        env:
          ENV_FOLDER: env/${{ inputs.org }}/${{ inputs.environment }}
      - name: Run fastlane generate certificates
        run: fastlane ios generate_new_certificates
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}