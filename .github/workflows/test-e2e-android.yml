name: E2E tests on Android
on:
  workflow_dispatch:
    inputs:
      api_level:
        description: 'Define API level'
        required: true
        default: 30
      system_image:
        description: 'Define system image'
        type: choice
        required: true
        default: 'default'
        options:
          - 'default'
          - 'google_apis'
          - 'google_apis_playstore'
      branch:
        description: 'Define branch to test'
        required: true
        default: 'master'
  schedule:
    - cron: '0 6 * * 1-5'

jobs:
  run_tests:
    name: E2E test Android
    runs-on: ubuntu-24.04
    environment: atb
    timeout-minutes: 90
    steps:
      - name: Set env variables
        env:
          DEFAULT_BRANCH: 'master'
          DEFAULT_API_LEVEL: 30
          DEFAULT_SYSTEM_IMAGE: 'default'
        run: |
          echo "INPUT_BRANCH=${{ github.event.inputs.branch || env.DEFAULT_BRANCH }}" >> $GITHUB_ENV
          echo "INPUT_API_LEVEL=${{ github.event.inputs.api_level || env.DEFAULT_API_LEVEL }}" >> $GITHUB_ENV
          echo "INPUT_SYSTEM_IMAGE=${{ github.event.inputs.system_image || env.DEFAULT_SYSTEM_IMAGE }}" >> $GITHUB_ENV          
          echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
      - name: Checkout project
        uses: actions/checkout@v4
        with:
          ref: ${{ env.INPUT_BRANCH }}

      - name: My cache
        if: env.INPUT_SYSTEM_IMAGE == 'default
        uses: actions/cache@v4
        id: my-cache
        with:
          path: |
            ~/myDir/*
          key: my-cache-id-${{ env.INPUT_SYSTEM_IMAGE }}-${{ env.INPUT_API_LEVEL }}
      - name: create AVD and generate snapshot for caching
        if: steps.my-cache.outputs.cache-hit != 'true' || env.INPUT_SYSTEM_IMAGE != 'default
        run: |
          echo "***** HIT ******"
          cd ~ && mkdir myDir
          touch myDir/myFile.txt
          ls -l myDir
      - name: Test
        run: echo "${{ steps.my-cache.outputs.cache-hit }}"
