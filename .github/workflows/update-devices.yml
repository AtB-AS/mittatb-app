name: Update new devices and provisioning profiles
on:
  push:
    branches:
      - 'jorelosorio/update-new-devices'
  workflow_dispatch:
    inputs:
      org:
        description: 'App organization to update provisioning profiles for'
        required: true
        type: choice
        options:
          - atb
          - fram
          - nfk
      match-type:
        description: 'Update provisioning profiles for which environment?'
        required: true
        type: choice
        options:
          - development
          - adhoc
jobs:
  update-devices:
    name: Update new devices and provisioning profiles
    environment: ${{ inputs.org }}
    timeout-minutes: 180
    runs-on: macOS-12
    steps:
      - name: Checkout project
        uses: actions/checkout@v1
      - name: Setup build dependencies, environment and assets
        uses: ./.github/actions/ios-build-setup
        with:
          use-build-cache: 'true'
          app-org: "atb"
          app-environment: 'development' # This is not used we only need ios-devices.txt, but required by the action
          git-crypt-key: ${{ secrets.GIT_CRYPT_KEY }}
      - name: Run fastlane generate provisioning profiles
        run: bundle exec fastlane ios update_devices
        env:
          FASTLANE_MATCH_TYPE: ${{ inputs.match-type }}
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
