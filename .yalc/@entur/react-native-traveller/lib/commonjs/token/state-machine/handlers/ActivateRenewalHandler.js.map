{"version":3,"sources":["ActivateRenewalHandler.ts"],"names":["activateRenewalHandler","abtTokensService","s","accountId","oldTokenId","tokenId","logger","info","undefined","signedToken","PayloadAction","addRemoveToken","activateTokenResponse","activateToken","attestationData","state","activatedData","err","response","status"],"mappings":";;;;;;;AAAA;;AAEA;;AACA;;AACA;;AACA;;AAEe,SAASA,sBAAT,CACbC,gBADa,EAEC;AACd,SAAO,yCAAoB,CAAC,iBAAD,CAApB,EAAyC,MAAOC,CAAP,IAAa;AAC3D,UAAM;AAAEC,MAAAA,SAAF;AAAaC,MAAAA,UAAb;AAAyBC,MAAAA;AAAzB,QAAqCH,CAA3C;;AAEAI,mBAAOC,IAAP,CAAY,kBAAZ,EAAgCC,SAAhC,EAA2C;AACzCL,MAAAA,SADyC;AAEzCC,MAAAA,UAFyC;AAGzCC,MAAAA;AAHyC,KAA3C;;AAMA,UAAMI,WAAW,GAAG,MAAM,4BAAeN,SAAf,EAA0BC,UAA1B,EAAsC,IAAtC,EAA4C,CACpEM,qBAAcC,cADsD,CAA5C,CAA1B;;AAIA,QAAI;AACF,YAAMC,qBAAqB,GAAG,MAAMX,gBAAgB,CAACY,aAAjB,CAClCR,OADkC,EAElCH,CAAC,CAACY,eAFgC,EAGlCL,WAHkC,CAApC;AAKA,uCAAqBJ,OAArB,EAA8BO,qBAAqB,CAACP,OAApD;AAEA,aAAO;AACLF,QAAAA,SAAS,EAAEA,SADN;AAELY,QAAAA,KAAK,EAAE,UAFF;AAGLV,QAAAA,OAAO,EAAEH,CAAC,CAACG,OAHN;AAILW,QAAAA,aAAa,EAAEJ;AAJV,OAAP;AAMD,KAdD,CAcE,OAAOK,GAAP,EAAiB;AAAA;;AACjB,UAAI,CAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,6BAAAA,GAAG,CAAEC,QAAL,gEAAeC,MAAf,MAA0B,GAA9B,EAAmC;AACjC;AACA,eAAO;AACLhB,UAAAA,SAAS,EAAEA,SADN;AAELE,UAAAA,OAAO,EAAEA,OAFJ;AAGLU,UAAAA,KAAK,EAAE;AAHF,SAAP;AAKD;;AACD,YAAME,GAAN;AACD;AACF,GAtCM,CAAP;AAuCD","sourcesContent":["import { getSecureToken } from '../../../native';\nimport type { AbtTokensService } from '../../abt-tokens-service';\nimport { PayloadAction } from '../../../native/types';\nimport { verifyCorrectTokenId } from '../utils';\nimport { StateHandler, stateHandlerFactory } from '../HandlerFactory';\nimport { logger } from '../../../logger';\n\nexport default function activateRenewalHandler(\n  abtTokensService: AbtTokensService\n): StateHandler {\n  return stateHandlerFactory(['ActivateRenewal'], async (s) => {\n    const { accountId, oldTokenId, tokenId } = s;\n\n    logger.info('activate_renewal', undefined, {\n      accountId,\n      oldTokenId,\n      tokenId,\n    });\n\n    const signedToken = await getSecureToken(accountId, oldTokenId, true, [\n      PayloadAction.addRemoveToken,\n    ]);\n\n    try {\n      const activateTokenResponse = await abtTokensService.activateToken(\n        tokenId,\n        s.attestationData,\n        signedToken\n      );\n      verifyCorrectTokenId(tokenId, activateTokenResponse.tokenId);\n\n      return {\n        accountId: accountId,\n        state: 'AddToken',\n        tokenId: s.tokenId,\n        activatedData: activateTokenResponse,\n      };\n    } catch (err: any) {\n      if (err?.response?.status === 409) {\n        // The token has already been renewed. May happen if retrying after timeout.\n        return {\n          accountId: accountId,\n          tokenId: tokenId,\n          state: 'GettingTokenCertificate',\n        };\n      }\n      throw err;\n    }\n  });\n}\n"]}