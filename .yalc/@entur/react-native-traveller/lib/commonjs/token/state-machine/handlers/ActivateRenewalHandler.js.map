{"version":3,"sources":["ActivateRenewalHandler.ts"],"names":["activateRenewalHandler","abtTokensService","s","signedToken","accountId","oldTokenId","PayloadAction","addRemoveToken","activateTokenResponse","activateToken","tokenId","attestationData","state","activatedData","err","response","status"],"mappings":";;;;;;;AAAA;;AAEA;;AACA;;AACA;;AAEe,SAASA,sBAAT,CACbC,gBADa,EAEC;AACd,SAAO,yCAAoB,CAAC,iBAAD,CAApB,EAAyC,MAAOC,CAAP,IAAa;AAC3D,UAAMC,WAAW,GAAG,MAAM,4BAAeD,CAAC,CAACE,SAAjB,EAA4BF,CAAC,CAACG,UAA9B,EAA0C,IAA1C,EAAgD,CACxEC,qBAAcC,cAD0D,CAAhD,CAA1B;;AAIA,QAAI;AACF,YAAMC,qBAAqB,GAAG,MAAMP,gBAAgB,CAACQ,aAAjB,CAClCP,CAAC,CAACQ,OADgC,EAElCR,CAAC,CAACS,eAFgC,EAGlCR,WAHkC,CAApC;AAKA,uCAAqBD,CAAC,CAACQ,OAAvB,EAAgCF,qBAAqB,CAACE,OAAtD;AAEA,aAAO;AACLN,QAAAA,SAAS,EAAEF,CAAC,CAACE,SADR;AAELQ,QAAAA,KAAK,EAAE,UAFF;AAGLC,QAAAA,aAAa,EAAEL;AAHV,OAAP;AAKD,KAbD,CAaE,OAAOM,GAAP,EAAiB;AAAA;;AACjB,UAAI,CAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,6BAAAA,GAAG,CAAEC,QAAL,gEAAeC,MAAf,MAA0B,GAA9B,EAAmC;AACjC;AACA,eAAO;AACLZ,UAAAA,SAAS,EAAEF,CAAC,CAACE,SADR;AAELM,UAAAA,OAAO,EAAER,CAAC,CAACQ,OAFN;AAGLE,UAAAA,KAAK,EAAE;AAHF,SAAP;AAKD;;AACD,YAAME,GAAN;AACD;AACF,GA7BM,CAAP;AA8BD","sourcesContent":["import { getSecureToken } from '../../../native';\nimport type { AbtTokensService } from '../../abt-tokens-service';\nimport { PayloadAction } from '../../../native/types';\nimport { verifyCorrectTokenId } from '../utils';\nimport { StateHandler, stateHandlerFactory } from '../HandlerFactory';\n\nexport default function activateRenewalHandler(\n  abtTokensService: AbtTokensService\n): StateHandler {\n  return stateHandlerFactory(['ActivateRenewal'], async (s) => {\n    const signedToken = await getSecureToken(s.accountId, s.oldTokenId, true, [\n      PayloadAction.addRemoveToken,\n    ]);\n\n    try {\n      const activateTokenResponse = await abtTokensService.activateToken(\n        s.tokenId,\n        s.attestationData,\n        signedToken\n      );\n      verifyCorrectTokenId(s.tokenId, activateTokenResponse.tokenId);\n\n      return {\n        accountId: s.accountId,\n        state: 'AddToken',\n        activatedData: activateTokenResponse,\n      };\n    } catch (err: any) {\n      if (err?.response?.status === 409) {\n        // The token has already been renewed. May happen if retrying after timeout.\n        return {\n          accountId: s.accountId,\n          tokenId: s.tokenId,\n          state: 'GettingTokenCertificate',\n        };\n      }\n      throw err;\n    }\n  });\n}\n"]}