{"version":3,"sources":["ValidatingHandler.ts"],"names":["validatingHandler","abtTokensService","s","accountId","tokenId","state","logger","info","undefined","signedToken","PayloadAction","getFarecontracts","validationState","validateToken"],"mappings":";;;;;;;AAEA;;AACA;;AACA;;AACA;;AAEe,SAASA,iBAAT,CACbC,gBADa,EAEC;AACd,SAAO,yCAAoB,CAAC,YAAD,CAApB,EAAoC,MAAOC,CAAP,IAAa;AACtD,UAAM;AAAEC,MAAAA,SAAF;AAAaC,MAAAA,OAAb;AAAsBC,MAAAA;AAAtB,QAAgCH,CAAtC;;AACAI,mBAAOC,IAAP,CAAY,2BAAZ,EAAyCC,SAAzC,EAAoD;AAClDL,MAAAA,SADkD;AAElDC,MAAAA,OAFkD;AAGlDC,MAAAA;AAHkD,KAApD;;AAKA,UAAMI,WAAW,GAAG,MAAM,4BAAeN,SAAf,EAA0BC,OAA1B,EAAmC,IAAnC,EAAyC,CACjEM,qBAAcC,gBADmD,CAAzC,CAA1B;AAGA,UAAM;AAAEN,MAAAA,KAAK,EAAEO;AAAT,QAA6B,MAAMX,gBAAgB,CAACY,aAAjB,CACvCT,OADuC,EAEvCK,WAFuC,CAAzC;;AAKAH,mBAAOC,IAAP,CAAY,8BAAZ,EAA4CC,SAA5C,EAAuD;AAAEI,MAAAA;AAAF,KAAvD;;AAEA,YAAQA,eAAR;AACE,WAAK,OAAL;AACE,eAAO;AACLT,UAAAA,SADK;AAELE,UAAAA,KAAK,EAAE,OAFF;AAGLD,UAAAA;AAHK,SAAP;;AAKF,WAAK,UAAL;AACA,WAAK,kBAAL;AACE,eAAO;AACLD,UAAAA,SADK;AAELE,UAAAA,KAAK,EAAE;AAFF,SAAP;;AAIF,WAAK,cAAL;AACE,eAAO;AACLF,UAAAA,SADK;AAELC,UAAAA,OAFK;AAGLC,UAAAA,KAAK,EAAE;AAHF,SAAP;AAdJ;AAoBD,GArCM,CAAP;AAsCD","sourcesContent":["import type { AbtTokensService } from '../../abt-tokens-service';\nimport type { StateHandler } from '../HandlerFactory';\nimport { stateHandlerFactory } from '../HandlerFactory';\nimport { getSecureToken } from '../../../native';\nimport { PayloadAction } from '../../../native/types';\nimport { logger } from '../../../logger';\n\nexport default function validatingHandler(\n  abtTokensService: AbtTokensService\n): StateHandler {\n  return stateHandlerFactory(['Validating'], async (s) => {\n    const { accountId, tokenId, state } = s;\n    logger.info('mobiletoken_status_change', undefined, {\n      accountId,\n      tokenId,\n      state,\n    });\n    const signedToken = await getSecureToken(accountId, tokenId, true, [\n      PayloadAction.getFarecontracts,\n    ]);\n    const { state: validationState } = await abtTokensService.validateToken(\n      tokenId,\n      signedToken\n    );\n\n    logger.info('mobiletoken_validation_state', undefined, { validationState });\n\n    switch (validationState) {\n      case 'Valid':\n        return {\n          accountId,\n          state: 'Valid',\n          tokenId,\n        };\n      case 'NotFound':\n      case 'NeedsReplacement':\n        return {\n          accountId,\n          state: 'DeleteLocal',\n        };\n      case 'NeedsRenewal':\n        return {\n          accountId,\n          tokenId,\n          state: 'InitiateRenewal',\n        };\n    }\n  });\n}\n"]}