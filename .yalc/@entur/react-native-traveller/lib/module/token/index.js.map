{"version":3,"sources":["index.ts"],"names":["loadingHandler","validatingHandler","initiateNewHandler","initiateRenewHandler","getTokenCertificateHandler","attestHandler","activateRenewalHandler","addTokenHandler","activateNewHandler","AsyncStorage","STORAGE_KEY","startTokenStateMachine","abtTokensService","setStatus","savedStateString","getItem","savedState","JSON","parse","undefined","currentState","state","shouldContinue","s","error","handler","getStateHandler","setItem","stringify","err","console","warn","type","message","storedState"],"mappings":"AAEA,OAAOA,cAAP,MAA2B,yCAA3B;AACA,OAAOC,iBAAP,MAA8B,4CAA9B;AACA,OAAOC,kBAAP,MAA+B,6CAA/B;AACA,OAAOC,oBAAP,MAAiC,iDAAjC;AACA,OAAOC,0BAAP,MAAuC,qDAAvC;AACA,OAAOC,aAAP,MAA0B,wCAA1B;AACA,OAAOC,sBAAP,MAAmC,iDAAnC;AACA,OAAOC,eAAP,MAA4B,0CAA5B;AAEA,OAAOC,kBAAP,MAA+B,6CAA/B;AACA,OAAOC,YAAP,MAAyB,2CAAzB;AAEA,MAAMC,WAAW,GAAG,uBAApB;AAEA,OAAO,MAAMC,sBAAsB,GAAG,OACpCC,gBADoC,EAEpCC,SAFoC,KAGjC;AACH,QAAMC,gBAAgB,GAAG,MAAML,YAAY,CAACM,OAAb,CAAqBL,WAArB,CAA/B;AACA,QAAMM,UAAU,GAAGF,gBAAgB,GAC/BG,IAAI,CAACC,KAAL,CAAWJ,gBAAX,CAD+B,GAE/BK,SAFJ;AAGA,MAAIC,YAAY,GAAGJ,UAAU,IAAI;AAAEK,IAAAA,KAAK,EAAE;AAAT,GAAjC;;AACA,MAAI;AACF,UAAMC,cAAc,GAAIC,CAAD,IAAoBA,CAAC,CAACF,KAAF,KAAY,OAAZ,IAAuB,CAACE,CAAC,CAACC,KAArE;;AACA,OAAG;AACD,YAAMC,OAAO,GAAGC,eAAe,CAACd,gBAAD,EAAmBQ,YAAnB,CAA/B;AACAA,MAAAA,YAAY,GAAG,MAAMK,OAAO,CAACL,YAAD,CAA5B;AACA,YAAMX,YAAY,CAACkB,OAAb,CAAqBjB,WAArB,EAAkCO,IAAI,CAACW,SAAL,CAAeR,YAAf,CAAlC,CAAN;AACAP,MAAAA,SAAS,CAACO,YAAD,CAAT;AACD,KALD,QAKSE,cAAc,CAACF,YAAD,CALvB;AAMD,GARD,CAQE,OAAOS,GAAP,EAAY;AACZC,IAAAA,OAAO,CAACC,IAAR,CAAa,kBAAb,EAAiCF,GAAjC;AACAhB,IAAAA,SAAS,CAAC,EACR,GAAGO,YADK;AAERI,MAAAA,KAAK,EAAE;AAAEQ,QAAAA,IAAI,EAAE,SAAR;AAAmBC,QAAAA,OAAO,EAAE,kBAA5B;AAAgDJ,QAAAA;AAAhD;AAFC,KAAD,CAAT;AAID;AACF,CAxBM;;AA0BP,MAAMH,eAAe,GAAG,CACtBd,gBADsB,EAEtBsB,WAFsB,KAGL;AACjB,UAAQA,WAAW,CAACb,KAApB;AACE,SAAK,OAAL;AACA,SAAK,SAAL;AACE,aAAOrB,cAAc,EAArB;;AACF,SAAK,YAAL;AACE,aAAOC,iBAAiB,CAACW,gBAAD,CAAxB;;AACF,SAAK,aAAL;AACE,aAAOV,kBAAkB,CAACU,gBAAD,CAAzB;;AACF,SAAK,iBAAL;AACE,aAAOT,oBAAoB,CAACS,gBAAD,CAA3B;;AACF,SAAK,yBAAL;AACE,aAAOR,0BAA0B,CAACQ,gBAAD,CAAjC;;AACF,SAAK,WAAL;AACA,SAAK,eAAL;AACE,aAAOP,aAAa,CAACO,gBAAD,CAApB;;AACF,SAAK,aAAL;AACE,aAAOJ,kBAAkB,CAACI,gBAAD,CAAzB;;AACF,SAAK,iBAAL;AACE,aAAON,sBAAsB,CAACM,gBAAD,CAA7B;;AACF,SAAK,UAAL;AACE,aAAOL,eAAe,CAACK,gBAAD,CAAtB;AApBJ;AAsBD,CA1BD","sourcesContent":["import type { AbtTokensService } from './abt-tokens-service';\nimport type { StoredState, TokenStatus } from './types';\nimport loadingHandler from './state-machine/handlers/LoadingHandler';\nimport validatingHandler from './state-machine/handlers/ValidatingHandler';\nimport initiateNewHandler from './state-machine/handlers/InitiateNewHandler';\nimport initiateRenewHandler from './state-machine/handlers/InitiateRenewalHandler';\nimport getTokenCertificateHandler from './state-machine/handlers/GetTokenCertificateHandler';\nimport attestHandler from './state-machine/handlers/AttestHandler';\nimport activateRenewalHandler from './state-machine/handlers/ActivateRenewalHandler';\nimport addTokenHandler from './state-machine/handlers/AddTokenHandler';\nimport type { StateHandler } from './state-machine/HandlerFactory';\nimport activateNewHandler from './state-machine/handlers/ActivateNewHandler';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\nconst STORAGE_KEY = '@mobiletokensdk-state';\n\nexport const startTokenStateMachine = async (\n  abtTokensService: AbtTokensService,\n  setStatus: (s: StoredState) => void\n) => {\n  const savedStateString = await AsyncStorage.getItem(STORAGE_KEY);\n  const savedState = savedStateString\n    ? JSON.parse(savedStateString)\n    : undefined;\n  let currentState = savedState || { state: 'Loading' };\n  try {\n    const shouldContinue = (s: TokenStatus) => s.state !== 'Valid' && !s.error;\n    do {\n      const handler = getStateHandler(abtTokensService, currentState);\n      currentState = await handler(currentState);\n      await AsyncStorage.setItem(STORAGE_KEY, JSON.stringify(currentState));\n      setStatus(currentState);\n    } while (shouldContinue(currentState));\n  } catch (err) {\n    console.warn('Unexpected error', err);\n    setStatus({\n      ...currentState,\n      error: { type: 'Unknown', message: 'Unexpected error', err },\n    });\n  }\n};\n\nconst getStateHandler = (\n  abtTokensService: AbtTokensService,\n  storedState: StoredState\n): StateHandler => {\n  switch (storedState.state) {\n    case 'Valid':\n    case 'Loading':\n      return loadingHandler();\n    case 'Validating':\n      return validatingHandler(abtTokensService);\n    case 'InitiateNew':\n      return initiateNewHandler(abtTokensService);\n    case 'InitiateRenewal':\n      return initiateRenewHandler(abtTokensService);\n    case 'GettingTokenCertificate':\n      return getTokenCertificateHandler(abtTokensService);\n    case 'AttestNew':\n    case 'AttestRenewal':\n      return attestHandler(abtTokensService);\n    case 'ActivateNew':\n      return activateNewHandler(abtTokensService);\n    case 'ActivateRenewal':\n      return activateRenewalHandler(abtTokensService);\n    case 'AddToken':\n      return addTokenHandler(abtTokensService);\n  }\n};\n"]}