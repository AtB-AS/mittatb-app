{"version":3,"sources":["InitiatingHandler.ts"],"names":["getActivateTokenRequestBody","addToken","verifyCorrectTokenId","Platform","requireAttestation","select","default","ios","initiatingHandler","abtTokensService","tokenId","initialTokenId","nonce","attestationEncryptionPublicKey","initToken","activateTokenRequestBody","certificate","tokenValidityEnd","tokenValidityStart","activateToken","state","err","error","type","message"],"mappings":"AAAA,SAASA,2BAAT,QAA4C,WAA5C;AACA,SAASC,QAAT,QAAyB,cAAzB;AAEA,SAASC,oBAAT,QAAqC,SAArC;AAEA,SAASC,QAAT,QAAyB,cAAzB;AAEA,MAAMC,kBAAkB,GAAGD,QAAQ,CAACE,MAAT,CAAgB;AACzCC,EAAAA,OAAO,EAAE,IADgC;AAEzCC,EAAAA,GAAG,EAAE;AAFoC,CAAhB,CAA3B;AAKA,eAAe,eAAeC,iBAAf,CACbC,gBADa,EAES;AACtB,MAAI;AACF,UAAM;AACJC,MAAAA,OAAO,EAAEC,cADL;AAEJC,MAAAA,KAFI;AAGJC,MAAAA;AAHI,QAIF,MAAMJ,gBAAgB,CAACK,SAAjB,CAA2B;AAAEV,MAAAA;AAAF,KAA3B,CAJV;AAKA,UAAMW,wBAAwB,GAAG,MAAMf,2BAA2B,CAChEW,cADgE,EAEhEC,KAFgE,EAGhEC,8BAHgE,CAAlE;AAMA,UAAM;AACJG,MAAAA,WADI;AAEJN,MAAAA,OAFI;AAGJO,MAAAA,gBAHI;AAIJC,MAAAA;AAJI,QAKF,MAAMT,gBAAgB,CAACU,aAAjB,CACRR,cADQ,EAERI,wBAFQ,CALV;AAUAb,IAAAA,oBAAoB,CAACS,cAAD,EAAiBD,OAAjB,CAApB;AACA,UAAMT,QAAQ,CAACS,OAAD,EAAUM,WAAV,EAAuBE,kBAAvB,EAA2CD,gBAA3C,CAAd;AACA,WAAO;AAAEG,MAAAA,KAAK,EAAE;AAAT,KAAP;AACD,GAzBD,CAyBE,OAAOC,GAAP,EAAY;AACZ,WAAO;AACLD,MAAAA,KAAK,EAAE,YADF;AAELE,MAAAA,KAAK,EAAE;AACLC,QAAAA,IAAI,EAAE,SADD;AAELC,QAAAA,OAAO,EAAE,4BAFJ;AAGLH,QAAAA;AAHK;AAFF,KAAP;AAQD;AACF","sourcesContent":["import { getActivateTokenRequestBody } from '../attest';\nimport { addToken } from '../../native';\nimport type { AbtTokensService } from '../abt-tokens-service';\nimport { verifyCorrectTokenId } from './utils';\nimport type { TokenStatus } from '../types';\nimport { Platform } from 'react-native';\n\nconst requireAttestation = Platform.select({\n  default: true,\n  ios: false,\n});\n\nexport default async function initiatingHandler(\n  abtTokensService: AbtTokensService\n): Promise<TokenStatus> {\n  try {\n    const {\n      tokenId: initialTokenId,\n      nonce,\n      attestationEncryptionPublicKey,\n    } = await abtTokensService.initToken({ requireAttestation });\n    const activateTokenRequestBody = await getActivateTokenRequestBody(\n      initialTokenId,\n      nonce,\n      attestationEncryptionPublicKey\n    );\n\n    const {\n      certificate,\n      tokenId,\n      tokenValidityEnd,\n      tokenValidityStart,\n    } = await abtTokensService.activateToken(\n      initialTokenId,\n      activateTokenRequestBody\n    );\n\n    verifyCorrectTokenId(initialTokenId, tokenId);\n    await addToken(tokenId, certificate, tokenValidityStart, tokenValidityEnd);\n    return { state: 'Valid' };\n  } catch (err) {\n    return {\n      state: 'Initiating',\n      error: {\n        type: 'Unknown',\n        message: 'Error initiating new token',\n        err,\n      },\n    };\n  }\n}\n"]}