{"version":3,"sources":["ActivateRenewalHandler.ts"],"names":["getSecureToken","PayloadAction","verifyCorrectTokenId","stateHandlerFactory","activateRenewalHandler","abtTokensService","getClientState","s","accountId","signedToken","addRemoveToken","activateTokenResponse","activateToken","tokenId","attestationData","state","activatedData","err","response","status"],"mappings":"AAAA,SAASA,cAAT,QAA+B,iBAA/B;AAEA,SAASC,aAAT,QAA8B,uBAA9B;AACA,SAASC,oBAAT,QAAqC,UAArC;AACA,SAAuBC,mBAAvB,QAAkD,mBAAlD;AAGA,eAAe,SAASC,sBAAT,CACbC,gBADa,EAEbC,cAFa,EAGC;AACd,SAAOH,mBAAmB,CAAC,CAAC,iBAAD,CAAD,EAAsB,MAAOI,CAAP,IAAa;AAC3D,UAAM;AAAEC,MAAAA;AAAF,QAAgBF,cAAc,EAApC;AACA,UAAMG,WAAW,GAAG,MAAMT,cAAc,CAACQ,SAAD,EAAY,CAClDP,aAAa,CAACS,cADoC,CAAZ,CAAxC;;AAIA,QAAI;AACF,YAAMC,qBAAqB,GAAG,MAAMN,gBAAgB,CAACO,aAAjB,CAClCL,CAAC,CAACM,OADgC,EAElCN,CAAC,CAACO,eAFgC,EAGlCL,WAHkC,CAApC;AAKAP,MAAAA,oBAAoB,CAACK,CAAC,CAACM,OAAH,EAAYF,qBAAqB,CAACE,OAAlC,CAApB;AAEA,aAAO;AACLE,QAAAA,KAAK,EAAE,UADF;AAELC,QAAAA,aAAa,EAAEL;AAFV,OAAP;AAID,KAZD,CAYE,OAAOM,GAAP,EAAiB;AAAA;;AACjB,UAAI,CAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,6BAAAA,GAAG,CAAEC,QAAL,gEAAeC,MAAf,MAA0B,GAA9B,EAAmC;AACjC;AACA,eAAO;AAAEJ,UAAAA,KAAK,EAAE;AAAT,SAAP;AACD;;AACD,YAAME,GAAN;AACD;AACF,GAzByB,CAA1B;AA0BD","sourcesContent":["import { getSecureToken } from '../../../native';\nimport type { AbtTokensService } from '../../abt-tokens-service';\nimport { PayloadAction } from '../../../native/types';\nimport { verifyCorrectTokenId } from '../utils';\nimport { StateHandler, stateHandlerFactory } from '../HandlerFactory';\nimport type { ClientStateRetriever } from '../../..';\n\nexport default function activateRenewalHandler(\n  abtTokensService: AbtTokensService,\n  getClientState: ClientStateRetriever\n): StateHandler {\n  return stateHandlerFactory(['ActivateRenewal'], async (s) => {\n    const { accountId } = getClientState();\n    const signedToken = await getSecureToken(accountId, [\n      PayloadAction.addRemoveToken,\n    ]);\n\n    try {\n      const activateTokenResponse = await abtTokensService.activateToken(\n        s.tokenId,\n        s.attestationData,\n        signedToken\n      );\n      verifyCorrectTokenId(s.tokenId, activateTokenResponse.tokenId);\n\n      return {\n        state: 'AddToken',\n        activatedData: activateTokenResponse,\n      };\n    } catch (err: any) {\n      if (err?.response?.status === 409) {\n        // The token has already been renewed. May happen if retrying after timeout.\n        return { state: 'GettingTokenCertificate' };\n      }\n      throw err;\n    }\n  });\n}\n"]}