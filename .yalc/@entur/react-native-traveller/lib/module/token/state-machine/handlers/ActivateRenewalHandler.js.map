{"version":3,"sources":["ActivateRenewalHandler.ts"],"names":["getSecureToken","PayloadAction","verifyCorrectTokenId","stateHandlerFactory","logger","activateRenewalHandler","abtTokensService","s","accountId","oldTokenId","tokenId","state","info","undefined","signedToken","addRemoveToken","activateTokenResponse","activateToken","attestationData","activatedData","err","response","status"],"mappings":"AAAA,SAASA,cAAT,QAA+B,iBAA/B;AAEA,SAASC,aAAT,QAA8B,uBAA9B;AACA,SAASC,oBAAT,QAAqC,UAArC;AACA,SAAuBC,mBAAvB,QAAkD,mBAAlD;AACA,SAASC,MAAT,QAAuB,iBAAvB;AAEA,eAAe,SAASC,sBAAT,CACbC,gBADa,EAEC;AACd,SAAOH,mBAAmB,CAAC,CAAC,iBAAD,CAAD,EAAsB,MAAOI,CAAP,IAAa;AAC3D,UAAM;AAAEC,MAAAA,SAAF;AAAaC,MAAAA,UAAb;AAAyBC,MAAAA,OAAzB;AAAkCC,MAAAA;AAAlC,QAA4CJ,CAAlD;AAEAH,IAAAA,MAAM,CAACQ,IAAP,CAAY,2BAAZ,EAAyCC,SAAzC,EAAoD;AAClDL,MAAAA,SADkD;AAElDC,MAAAA,UAFkD;AAGlDC,MAAAA,OAHkD;AAIlDC,MAAAA;AAJkD,KAApD;AAOA,UAAMG,WAAW,GAAG,MAAMd,cAAc,CAACQ,SAAD,EAAYC,UAAZ,EAAwB,IAAxB,EAA8B,CACpER,aAAa,CAACc,cADsD,CAA9B,CAAxC;;AAIA,QAAI;AACF,YAAMC,qBAAqB,GAAG,MAAMV,gBAAgB,CAACW,aAAjB,CAClCP,OADkC,EAElCH,CAAC,CAACW,eAFgC,EAGlCJ,WAHkC,CAApC;AAKAZ,MAAAA,oBAAoB,CAACQ,OAAD,EAAUM,qBAAqB,CAACN,OAAhC,CAApB;AAEA,aAAO;AACLF,QAAAA,SAAS,EAAEA,SADN;AAELG,QAAAA,KAAK,EAAE,UAFF;AAGLD,QAAAA,OAAO,EAAEH,CAAC,CAACG,OAHN;AAILS,QAAAA,aAAa,EAAEH;AAJV,OAAP;AAMD,KAdD,CAcE,OAAOI,GAAP,EAAiB;AAAA;;AACjB,UAAI,CAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,6BAAAA,GAAG,CAAEC,QAAL,gEAAeC,MAAf,MAA0B,GAA9B,EAAmC;AACjC;AACA,eAAO;AACLd,UAAAA,SAAS,EAAEA,SADN;AAELE,UAAAA,OAAO,EAAEA,OAFJ;AAGLC,UAAAA,KAAK,EAAE;AAHF,SAAP;AAKD;;AACD,YAAMS,GAAN;AACD;AACF,GAvCyB,CAA1B;AAwCD","sourcesContent":["import { getSecureToken } from '../../../native';\nimport type { AbtTokensService } from '../../abt-tokens-service';\nimport { PayloadAction } from '../../../native/types';\nimport { verifyCorrectTokenId } from '../utils';\nimport { StateHandler, stateHandlerFactory } from '../HandlerFactory';\nimport { logger } from '../../../logger';\n\nexport default function activateRenewalHandler(\n  abtTokensService: AbtTokensService\n): StateHandler {\n  return stateHandlerFactory(['ActivateRenewal'], async (s) => {\n    const { accountId, oldTokenId, tokenId, state } = s;\n\n    logger.info('mobiletoken_status_change', undefined, {\n      accountId,\n      oldTokenId,\n      tokenId,\n      state,\n    });\n\n    const signedToken = await getSecureToken(accountId, oldTokenId, true, [\n      PayloadAction.addRemoveToken,\n    ]);\n\n    try {\n      const activateTokenResponse = await abtTokensService.activateToken(\n        tokenId,\n        s.attestationData,\n        signedToken\n      );\n      verifyCorrectTokenId(tokenId, activateTokenResponse.tokenId);\n\n      return {\n        accountId: accountId,\n        state: 'AddToken',\n        tokenId: s.tokenId,\n        activatedData: activateTokenResponse,\n      };\n    } catch (err: any) {\n      if (err?.response?.status === 409) {\n        // The token has already been renewed. May happen if retrying after timeout.\n        return {\n          accountId: accountId,\n          tokenId: tokenId,\n          state: 'GettingTokenCertificate',\n        };\n      }\n      throw err;\n    }\n  });\n}\n"]}