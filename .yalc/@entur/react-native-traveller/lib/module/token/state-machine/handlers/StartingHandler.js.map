{"version":3,"sources":["StartingHandler.ts"],"names":["stateHandlerFactory","AsyncStorage","getStoreKey","getAttestationSupport","start","startNative","logger","startingHandler","safetyNetApiKey","forceRestart","s","accountId","state","result","info","undefined","attestationSupport","storeKey","savedStateString","getItem","savedState","JSON","parse","error"],"mappings":"AACA,SAASA,mBAAT,QAAoC,mBAApC;AACA,OAAOC,YAAP,MAAyB,2CAAzB;AACA,SAASC,WAAT,QAA4B,UAA5B;AACA,SAASC,qBAAT,EAAgCC,KAAK,IAAIC,WAAzC,QAA4D,iBAA5D;AAEA,SAASC,MAAT,QAAuB,iBAAvB;AAEA,eAAe,SAASC,eAAT,CACbC,eADa,EAEbC,YAFa,EAGC;AACd,SAAOT,mBAAmB,CAAC,CAAC,UAAD,CAAD,EAAe,MAAOU,CAAP,IAAa;AACpD,UAAM;AAAEC,MAAAA,SAAF;AAAaC,MAAAA;AAAb,QAAuBF,CAA7B;AACA,UAAM;AAAEG,MAAAA;AAAF,QAAa,MAAMV,qBAAqB,EAA9C;AACAG,IAAAA,MAAM,CAACQ,IAAP,CAAY,2BAAZ,EAAyCC,SAAzC,EAAoD;AAClDJ,MAAAA,SADkD;AAElDK,MAAAA,kBAAkB,EAAEH,MAF8B;AAGlDD,MAAAA;AAHkD,KAApD;;AAMA,QAAIC,MAAM,KAAK,WAAf,EAA4B;AAC1B,aAAO;AAAEF,QAAAA,SAAF;AAAaC,QAAAA,KAAK,EAAE;AAApB,OAAP;AACD;;AAED,UAAMK,QAAQ,GAAGf,WAAW,CAACS,SAAD,CAA5B;AACA,UAAMN,WAAW,CAACG,eAAD,CAAjB;;AAEA,QAAIC,YAAJ,EAAkB;AAChBH,MAAAA,MAAM,CAACQ,IAAP,CAAY,4BAAZ,EAA0CC,SAA1C,EAAqD;AAAEJ,QAAAA;AAAF,OAArD;AACA,aAAO;AACLA,QAAAA,SADK;AAELC,QAAAA,KAAK,EAAE;AAFF,OAAP;AAID;;AAED,UAAMM,gBAAgB,GAAG,MAAMjB,YAAY,CAACkB,OAAb,CAAqBF,QAArB,CAA/B;;AAEA,QAAI,CAACC,gBAAL,EAAuB;AACrBZ,MAAAA,MAAM,CAACQ,IAAP,CAAY,+BAAZ,EAA6CC,SAA7C,EAAwD;AAAEJ,QAAAA;AAAF,OAAxD;AACA,aAAO;AACLA,QAAAA,SADK;AAELC,QAAAA,KAAK,EAAE;AAFF,OAAP;AAID;;AAED,UAAMQ,UAAuB,GAAGC,IAAI,CAACC,KAAL,CAAWJ,gBAAX,CAAhC;AAEAZ,IAAAA,MAAM,CAACQ,IAAP,CAAY,0BAAZ,EAAwCC,SAAxC,EAAmD;AACjDH,MAAAA,KAAK,EAAEQ,UAAU,CAACR,KAD+B;AAEjDD,MAAAA,SAAS,EAAES,UAAU,CAACT;AAF2B,KAAnD;;AAKA,QAAIS,UAAU,CAACR,KAAX,KAAqB,OAAzB,EAAkC;AAChC,aAAO;AACLD,QAAAA,SADK;AAELC,QAAAA,KAAK,EAAE;AAFF,OAAP;AAID;;AAED,WAAO,EACL,GAAGQ,UADE;AAELG,MAAAA,KAAK,EAAER;AAFF,KAAP;AAID,GApDyB,CAA1B;AAqDD","sourcesContent":["import type { StateHandler } from '../HandlerFactory';\nimport { stateHandlerFactory } from '../HandlerFactory';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { getStoreKey } from '../utils';\nimport { getAttestationSupport, start as startNative } from '../../../native';\nimport type { StoredState } from 'src/token/types';\nimport { logger } from '../../../logger';\n\nexport default function startingHandler(\n  safetyNetApiKey: string,\n  forceRestart: boolean\n): StateHandler {\n  return stateHandlerFactory(['Starting'], async (s) => {\n    const { accountId, state } = s;\n    const { result } = await getAttestationSupport();\n    logger.info('mobiletoken_status_change', undefined, {\n      accountId,\n      attestationSupport: result,\n      state,\n    });\n\n    if (result !== 'SUPPORTED') {\n      return { accountId, state: 'NotSupported' };\n    }\n\n    const storeKey = getStoreKey(accountId);\n    await startNative(safetyNetApiKey);\n\n    if (forceRestart) {\n      logger.info('mobiletoken_forced_restart', undefined, { accountId });\n      return {\n        accountId,\n        state: 'Loading',\n      };\n    }\n\n    const savedStateString = await AsyncStorage.getItem(storeKey);\n\n    if (!savedStateString) {\n      logger.info('mobiletoken_no_existing_state', undefined, { accountId });\n      return {\n        accountId,\n        state: 'Loading',\n      };\n    }\n\n    const savedState: StoredState = JSON.parse(savedStateString);\n\n    logger.info('mobiletoken_loaded_state', undefined, {\n      state: savedState.state,\n      accountId: savedState.accountId,\n    });\n\n    if (savedState.state === 'Valid') {\n      return {\n        accountId,\n        state: 'Loading',\n      };\n    }\n\n    return {\n      ...savedState,\n      error: undefined,\n    };\n  });\n}\n"]}