require_relative '../node_modules/react-native/scripts/react_native_pods'
require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'

platform :ios, '10.0'

$ReactNativeMapboxGLIOSVersion = '6.3.0'

target 'atb' do
  # Pods for atb
  config = use_native_modules!
  use_react_native!(:path => config["reactNativePath"])

  pod "Intercom"
  
  permissions_path = '../node_modules/react-native-permissions/ios'
  pod 'Permission-LocationWhenInUse', :path => "#{permissions_path}/LocationWhenInUse.podspec"

  target 'atbTests' do
    inherit! :search_paths
    # Pods for testing
  end

  # Enables Flipper.
  #
  # Note that if you have use_frameworks! enabled, Flipper will not work and
  # you should disable these next few lines.
  use_flipper!
  post_install do |installer|
    flipper_post_install(installer)
    adjust_copy_dsyms_phase(installer)
  end
end

target 'atb-tvOS' do
  # Pods for atb-tvOS

  target 'atb-tvOSTests' do
    inherit! :search_paths
    # Pods for testing
  end

end

# https://github.com/CocoaPods/CocoaPods/issues/10373
def adjust_copy_dsyms_phase(installer)
  [
      installer.development_pod_targets.map { |t| t.copy_dsyms_script_input_files_path },
      installer.development_pod_targets.map { |t| t.copy_dsyms_script_output_files_path },
      installer.development_pod_targets.map { |t| t.copy_dsyms_script_path }
  ].each { |files|
      already_included_bcsymbolmap_files = []
      files.each { |file|
          next if not File.exist?(file) 
          already_included_bcsymbolmap_files += remove_duplicated_bcsymbolmap_lines(file, already_included_bcsymbolmap_files)
      }
  }
end

def remove_duplicated_bcsymbolmap_lines(path, already_included_bcsymbolmap_files)
  lines = []
  bcsymbolmap_ids = []

  for line in File.readlines(path).map { |line| line.strip }
      if line.include? ".bcsymbolmap"
          # Workaround for https://github.com/CocoaPods/CocoaPods/issues/10373 
          next if lines.include? line

          # Workaround for https://github.com/CocoaPods/CocoaPods/issues/10385
          bcsymbolmap_id = File.basename(line.tr('"', ''), ".bcsymbolmap")
          if not already_included_bcsymbolmap_files.include? bcsymbolmap_id
              lines.append(line)
              bcsymbolmap_ids.append(bcsymbolmap_id)
          end
      else
          lines.append(line)
      end
  end

  File.open(path, "w+") do |f|
      f.puts(lines)
  end

  return bcsymbolmap_ids
end
